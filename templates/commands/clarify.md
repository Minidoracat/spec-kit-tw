---
description: 透過詢問最多5個高度針對性的澄清問題來識別當前功能規範中的未指定領域，並將答案編碼回規範。
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --paths-only
  ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

使用者輸入可以直接由代理提供或作為命令參數提供給您 - 您**必須**考慮它（如果不為空）。

使用者輸入：

$ARGUMENTS

目標：檢測並減少活動功能規範中的模糊性或缺失決策點，並將澄清直接記錄在規範檔案中。

注意：此澄清工作流程應在調用 `/plan` **之前**執行（並完成）。如果使用者明確表示跳過澄清（例如，探索性原型開發），可以繼續，但必須警告下游返工風險增加。

執行步驟：

1. 從倉儲根目錄執行一次 `{SCRIPT}` **（組合 `--json --paths-only` 模式 / `-Json -PathsOnly`）。解析最小JSON負載欄位：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可選捕獲 `IMPL_PLAN`、`TASKS` 以用於未來鏈式流）。
   - 如果JSON解析失敗，中止並指示使用者重新執行 `/specify` 或驗證功能分支環境。

2. 載入當前規範檔案。使用此分類框架執行結構化模糊性和覆蓋掃描。對於每個類別，標記狀態：清晰 / 部分 / 缺失。生成用於優先化的內部覆蓋映射（除非將不詢問問題，否則不輸出原始映射）。

   功能範圍和行為：
   - 核心使用者目標和成功標準
   - 明確的範圍外聲明
   - 使用者角色/角色區分

   領域和資料模型：
   - 實體、屬性、關係
   - 身份和唯一性規則
   - 生命週期/狀態轉換
   - 資料量/規模假設

   互動和UX流程：
   - 關鍵使用者旅程/序列
   - 錯誤/空/載入狀態
   - 可訪問性或本地化說明

   非功能品質屬性：
   - 效能（延遲、吞吐量目標）
   - 可擴展性（水平/垂直，限制）
   - 可靠性和可用性（正常運行時間、恢復期望）
   - 可觀察性（日誌記錄、指標、追蹤訊號）
   - 安全性和隱私（身份驗證/授權、資料保護、威脅假設）
   - 合規性/監管約束（如果有）

   整合和外部依賴：
   - 外部服務/API及其故障模式
   - 資料匯入/匯出格式
   - 協議/版本控制假設

   邊界情況和故障處理：
   - 負面場景
   - 速率限制/節流
   - 衝突解決（例如，並行編輯）

   約束和權衡：
   - 技術約束（語言、儲存、託管）
   - 明確權衡或拒絕的替代方案

   術語和一致性：
   - 規範術語表術語
   - 避免的同義詞/已棄用術語

   完成訊號：
   - 驗收標準的可測試性
   - 可衡量的「完成」風格定義指示器

   雜項/佔位符：
   - TODO 標記/未解決的決策
   - 缺少量化的模糊形容詞（「健壯」、「直覺」）

   對於每個狀態為部分或缺失的類別，新增候選問題機會，除非：
   - 澄清不會實質性地改變實施或驗證策略
   - 資訊更適合推遲到規劃階段（內部記錄）

3. 生成（內部）候選澄清問題的優先級佇列（最多5個）。不要一次性輸出它們。應用這些約束：
   - 整個會話最多5個問題。
   - 每個問題必須可以用以下任一方式回答：
       * 簡短的多項選擇題（2–5個不同且互斥的選項），或
       * 單詞/短短語答案（明確約束：「答案<=5個詞」）。
   - 只包含其答案實質上影響架構、資料建模、任務分解、測試設計、UX行為、運營準備度或合規性驗證的問題。
   - 確保類別覆蓋平衡：嘗試首先覆蓋最高影響的未解決類別；當單個高影響領域（例如，安全姿態）未解決時，避免詢問兩個低影響問題。
   - 排除已回答的問題、瑣碎的風格偏好，或計畫級執行細節（除非阻礙正確性）。
   - 偏好減少下游返工風險或防止錯誤驗收測試的澄清。
   - 如果餘下超過5個類別未解決，按（影響度 × 不確定性）評估標準選擇前5個。

4. 順序提問循環（互動式）：
   - 一次只呈現**一個**問題。
   - 對於多項選擇題，將選項呈現為Markdown表：

       | 選項 | 描述 |
       |--------|-------------|
       | A | <選項A描述> |
       | B | <選項B描述> |
       | C | <選項C描述> | （根據需要新增D/E，最多5個）
       | 簡答 | 提供不同的短答案（<=5個詞） | （僅在自由形式替代合適時包含）

   - 對於短答案風格（無有意義離散選項），在問題後輸出單行：`格式：短答案（<=5個詞）`。
   - 使用者回答後：
       * 驗證答案映射到一個選項或符合<=5個詞約束。
       * 如果模糊，要求快速消歧義（計數仍屬於同一問題；不要前進）。
       * 一旦滿意，將其記錄在工作記憶中（尚未寫入磁碟）並移動到下一個排隊問題。
   - 在以下情況停止進一步提問：
       * 所有關鍵模糊性早期解決（餘下排隊項變得不必要），或
       * 使用者發出完成訊號（「完成」、「好」、「沒有更多」），或
       * 您達到5個已問問題。
   - 永遠不要提前揭示未來排隊的問題。
   - 如果開始時沒有有效問題存在，立即報告沒有關鍵模糊性。

5. 每個接受答案後的整合（增量更新方法）：
   - 維護規範的內存表示（在開始時載入一次）加上原始檔案內容。
   - 對於此會話中第一個整合的答案：
       * 確保 `## 澄清` 部分存在（如果缺失，就在規範模板的最高級上下文/概述部分之後建立它）。
       * 在其下，為今天建立（如果不存在）`### 會話 YYYY-MM-DD` 子標題。
   - 在驗收後立即新增項目符號行：`- Q: <問題> → A: <最終答案>`。
   - 然後立即將澄清應用於最合適的部分：
       * 功能模糊性 → 更新或在功能需求中新增項目符號。
       * 使用者互動/角色區分 → 使用澄清的角色、約束或場景更新使用者故事或角色小節（如果存在）。
       * 資料形狀/實體 → 更新資料模型（新增欄位、類型、關係）保持順序；簡潔地記錄新增的約束。
       * 非功能約束 → 在非功能/品質屬性部分新增/修改可衡量標準（將模糊形容詞轉換為指標或明確目標）。
       * 邊界情況/負流程 → 在邊界情況/錯誤處理下新增新項目符號（如果模板為其提供佔位符則建立此類小節）。
       * 術語衝突 → 在整個規範中規範化術語；僅在必要時透過新增 `(先前稱為「X」)` 保留原始術語。
   - 如果澄清代替了較早的模糊陳述，替換該陳述而不是複製；不要留下過時的矛盾文字。
   - 每次整合後儲存規範檔案以最小化上下文遺失風險（原子覆蓋）。
   - 保留格式：不要重新排序無關部分；保持標題層次結構完整。
   - 保持每個插入的澄清最小化和可測試（避免敘述漂移）。

6. 驗證（每次寫入後執行加上最終遍歷）：
   - 澄清會話包含每個接受答案正好一個項目符號（無重複）。
   - 已問（接受）問題數 ≤ 5。
   - 更新的部分包含新答案旨在解決的剩餘模糊佔位符。
   - 沒有餘下的矛盾較早陳述（掃描移除的現在無效替代選擇）。
   - Markdown結構有效；只允許新標題：`## 澄清`、`### 會話 YYYY-MM-DD`。
   - 術語一致性：在所有更新部分中使用相同的規範術語。

7. 將更新的規範寫回 `FEATURE_SPEC`。

8. 報告完成（提問循環結束或提前終止後）：
   - 已問和已回答的問題數。
   - 更新規範的路徑。
   - 觸及的部分列表（名稱）。
   - 覆蓋摘要表列出每個分類法類別，狀態為：已解決（曾經為部分/缺失並已處理）、推遲（超出問題配額或更適合規劃）、清晰（已經足夠）、突出（仍然部分/缺失但低影響）。
   - 如果任何突出或推遲餘下，建議是否繼續到 `/plan` 或在規劃後再次執行 `/clarify`。
   - 建議的下一個命令。

行為規則：
- 如果沒有發現有意義的模糊性（或所有潛在問題都是低影響），回應：「未發現值得正式澄清的關鍵模糊性。」並建議繼續。
- 如果規範檔案缺失，指示使用者首先執行 `/specify`（不要在此建立新規範）。
- 永遠不要超過5個總已問問題（單個問題的澄清重試不計為新問題）。
- 避免推測性技術堆疊問題，除非缺失阻礙功能清晰度。
- 尊重使用者提前終止訊號（「停止」、「完成」、「繼續」）。
- 如果由於完全覆蓋而沒有問問題，輸出緊湊的覆蓋摘要（所有類別清晰）然後建議前進。
- 如果達到配額時餘下未解決的高影響類別，在推遲下明確標記它們及其基本原理。

優先化上下文：{ARGS}
