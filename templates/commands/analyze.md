---
description: 在任務生成後，對 spec.md、plan.md 和 tasks.md 執行非破壞性的跨工件一致性和質量分析。
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

使用者輸入可以直接由代理提供或作為命令參數提供給您 - 您**必須**考慮它（如果不為空）。

使用者輸入：

$ARGUMENTS

目標：在實施前識別三個核心工件（`spec.md`、`plan.md`、`tasks.md`）之間的不一致性、重複、模糊性和未指定項。此命令必須在 `/tasks` 成功生成完整的 `tasks.md` 後運行。

嚴格唯讀：**不要**修改任何檔案。輸出結構化分析報告。提供可選的修復計畫（使用者必須明確批准，任何後續編輯命令都將手動調用）。

章程權威：專案章程（`/memory/constitution.md`）在此分析範圍內是**不可協商的**。章程衝突自動為CRITICAL，需要調整規範、計畫或任務——而不是稀釋、重新解釋或靜默忽略原則。如果原則本身需要更改，那必須在 `/analyze` 之外的單獨、明確的章程更新中發生。

執行步驟：

1. 從倉儲根目錄執行一次 `{SCRIPT}` 並解析 JSON 以獲取 FEATURE_DIR 和 AVAILABLE_DOCS。推導絕對路徑：
   - SPEC = FEATURE_DIR/spec.md
   - PLAN = FEATURE_DIR/plan.md
   - TASKS = FEATURE_DIR/tasks.md
   如果任何必需檔案缺失則中止並顯示錯誤訊息（指示使用者執行缺失的先決條件命令）。

2. 載入工件：
   - 解析 spec.md 部分：概述/上下文、功能需求、非功能需求、使用者故事、邊界情況（如果存在）。
   - 解析 plan.md：架構/技術堆疊選擇、資料模型參考、階段、技術約束。
   - 解析 tasks.md：任務ID、描述、階段分組、並行標記 [P]、參考的檔案路徑。
   - 載入章程 `/memory/constitution.md` 以進行原則驗證。

3. 建構內部語義模型：
   - 需求清單：每個功能+非功能需求都有穩定鍵（基於祈使短語推導slug；例如，「使用者可以上傳檔案」 -> `user-can-upload-file`）。
   - 使用者故事/行動清單。
   - 任務覆蓋映射：將每個任務映射到一個或多個需求或故事（透過關鍵字/明確參考模式如ID或關鍵短語進行推斷）。
   - 章程規則集：提取原則名稱和任何 MUST/SHOULD 規範性陳述。

4. 檢測過程：
   A. 重複檢測：
      - 識別近乎重複的需求。標記較低品質的措辭以進行合併。
   B. 模糊性檢測：
      - 標記缺乏可衡量標準的模糊形容詞（快速、可擴展、安全、直覺、健壯）。
      - 標記未解決的佔位符（TODO、TKTK、???、<placeholder> 等）。
   C. 未指定性檢測：
      - 有動詞但缺少物件或可衡量結果的需求。
      - 缺少驗收標準對齊的使用者故事。
      - 參考規範/計畫中未定義的檔案或元件的任務。
   D. 章程對齊：
      - 任何與 MUST 原則衝突的需求或計畫元素。
      - 缺少章程中規定的部分或品質門控。
   E. 覆蓋空白：
      - 零個關聯任務的需求。
      - 沒有映射需求/故事的任務。
      - 任務中未反映的非功能需求（例如，效能、安全性）。
   F. 不一致性：
      - 術語漂移（相同概念在不同檔案中命名不同）。
      - 計畫中參考但規範中缺失的資料實體（反之亦然）。
      - 任務順序矛盾（例如，整合任務在沒有依賴說明的情況下先於基礎設置任務）。
      - 衝突的需求（例如，一個要求使用 Next.js 而另一個說使用 Vue 作為框架）。

5. 嚴重性分配評估標準：
   - CRITICAL：違反章程 MUST、缺失核心規範工件、或零覆蓋阻礙基線功能的需求。
   - HIGH：重複或衝突的需求、模糊的安全/效能屬性、不可測試的驗收標準。
   - MEDIUM：術語漂移、缺少非功能任務覆蓋、未指定的邊界情況。
   - LOW：樣式/措辭改進、不影響執行順序的輕微重複。

6. 生成Markdown報告（無檔案寫入），包含以下部分：

   ### 規範分析報告
   | ID | 類別 | 嚴重性 | 位置 | 摘要 | 建議 |
   |----|--------|----------|------|---------|---------|
   | A1 | 重複 | HIGH | spec.md:L120-134 | 兩個相似需求... | 合併措辭；保留更清晰版本 |
   （每個發現新增一行；按類別首字母生成穩定ID。）

   附加小節：
   - 覆蓋摘要表：
     | 需求鍵 | 有任務？ | 任務ID | 備註 |
   - 章程對齊問題（如果有）
   - 未映射任務（如果有）
   - 指標：
     * 總需求數
     * 總任務數
     * 覆蓋百分比（具有>=1個任務的需求）
     * 模糊性計數
     * 重複計數
     * 關鍵問題計數

7. 在報告末尾，輸出簡潔的後續操作區塊：
   - 如果存在CRITICAL問題：建議在 `/implement` 前解決。
   - 如果只有LOW/MEDIUM：使用者可以繼續，但提供改進建議。
   - 提供明確命令建議：例如，「執行 /specify 進行細化」、「執行 /plan 調整架構」、「手動編輯 tasks.md 新增 'performance-metrics' 的覆蓋」。

8. 詢問使用者：「您希望我為前N個問題建議具體的修復編輯嗎？」（不要自動應用它們。）

行為規則：
- 永遠不要修改檔案。
- 永遠不要虛構缺失部分——如果缺失，報告它們。
- 保持發現確定性：如果無更改重新執行，產生一致的ID和計數。
- 限制主表中的總發現數到50；在彙總溢出註釋中聚合餘數。
- 如果發現零問題，發出包含覆蓋統計和繼續建議的成功報告。

上下文：{ARGS}
